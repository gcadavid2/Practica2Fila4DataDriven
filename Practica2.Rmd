---
title: "Practica2"
output: html_document
date: "2025-01-13"
---

```{r setup, include=FALSE}
require(httr)
require(xml2)
require(rvest)
require(tidytable)
require(dplyr)
require(purrr)
require(stringr)
require(knitr)
require(kableExtra)
```

```{r functions, include=FALSE}
parse_href <- function(href) {
  href_clean <- str_trim(href)
  ifelse(
    startsWith(href_clean, "#"),
    paste(FULL_URL_CONST, href_clean, sep = ""),
    ifelse(
      startsWith(href_clean, "/"),
      gsub("^/", BASE_URL_CONST, href_clean),
      href_clean
    )
  )
}
parse_href_v <- Vectorize(parse_href)

# 0 - relativa
# 1 - absoluta
parse_href_type <- function(href) {
  href_clean <- str_trim(href)
  ifelse(
    startsWith(href_clean, "#"),
    0,
    ifelse(
      startsWith(href_clean, "/"),
      0,
      1
    )
  )
}
parse_href_type_v <- Vectorize(parse_href_type)

check_link <- function(href) {
  Sys.sleep(0.2)
  response <- GET(href)
  status_code(response)
}
check_link_v <- Vectorize(check_link)
```

```{r globals, include=FALSE}
FULL_URL_CONST <- "https://www.mediawiki.org/wiki/MediaWiki/"
BASE_URL_CONST <- "https://www.mediawiki.org/"
```

```{r read_and_process_raw_data, include=FALSE}
html <- read_html(BASE_URL_CONST)

title <- html %>%
  html_elements("title") %>%
  html_text2()
a_objects <- html %>% html_elements("a")

raw_links <- data.frame(
  href = a_objects %>% html_attr("href"),
  text = a_objects %>% html_text()
)

raw_links <- raw_links %>% slice_head(n = 10) # processa nomes el top 10
```

```{r transform_data}
links <- raw_links %>%
  na.omit() %>%
  count(href, text, name = "freq") %>%
  mutate(href_type = parse_href_type_v(href)) %>%
  mutate(href = parse_href_v(href)) %>%
  rowwise() %>%
  mutate(status = check_link_v(href))

show(links)
```

```{r display_data}
links %>%
  kbl(
    caption = ,
    #col.names = c("Enlace", "Texto", "Visto", "Estado", "Tipo"),
    align = "llccc",
  ) %>%
  add_header_above(c("Cabecera" = 1, setNames(4, title))) %>%
  kable_styling(bootstrap_options = c("responsive"))
```
